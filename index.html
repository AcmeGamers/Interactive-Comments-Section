<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- displays site properly based on user's device -->

    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="./images/favicon-32x32.png"
    />

    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <title>Frontend Mentor | Interactive comments section</title>

    <link
      href="https://fonts.googleapis.com/css?family=Rubik:400,500,700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <main class="column hr-center">
      <!-- Comment Card Container -->
      <div id="root"></div>
    </main>

    <script type="text/babel">
      function Card(props) {
        return (
          <div>
            <div className={"card row " + props.class}>
              <div className="column upvoting vr-center hr-center">
                <a href="#">+</a>
                <span>{props.score}</span>
                <a href="#">-</a>
              </div>

              <div className="full-width">
                <div className="row space-between hr-center">
                  <div className="user-info row hr-center">
                    <img className="user" src={props.image} alt="" />
                    <a className="username mg-l-15px-r-10px">
                      {props.username}
                    </a>
                    {props.currentUser &&
                      props.username == props.currentUser.username && (
                        <p className="tag mg-r-10px">you</p>
                      )}
                    <p className="period">{props.createdAt}</p>
                  </div>
                  <button className="btn btn-reply">
                    <img src="./images/icon-reply.svg" /> Reply
                  </button>
                </div>
                <p className="comment">{props.content}</p>
              </div>
            </div>
            {props.children && (
              <div className="card-reply-container column hr-right">
                {props.children}
              </div>
            )}
          </div>
        );
      }
      function CardReply(props) {
        return (
          <Card
            key={props.id}
            score={props.score}
            username={props.username}
            createdAt={props.createdAt}
            content={props.content}
            image={props.image}
            currentUser={props.currentUser}
            class="card-reply"
          />
        );
      }

      class CommentCard extends React.Component {
        constructor(props) {
          super(props);
          this.userComment = React.createRef();
          this.state = {
            comments: props.comments,
            currentUser: props.currentUser,
          };
        }

        render() {
          return (
            <div className="card row vr-top space-between">
              <img
                className="user"
                src={this.state.currentUser.image.png}
                alt=""
              />
              <textarea
                name="text"
                type="text"
                placeholder="Add a comment..."
                className="mg-lr-10px"
                cols="30"
                rows="10"
                ref={this.userComment}
              ></textarea>
              <button
                className="btn btn-send"
                onClick={() => {
                  this.props.commentHandler(this.userComment.current.value);
                }}
              >
                Send
              </button>
            </div>
          );
        }
      }

      function CardEditReply() {
        return (
          <div className="card row">
            <div className="column upvoting vr-center hr-center">
              <a href="#">+</a>
              <span>5</span>
              <a href="#">-</a>
            </div>
            <div className="full-width">
              <div className="row space-between hr-center">
                <div className="user-info row hr-center">
                  <img
                    className="user"
                    src="./images/avatars/image-amyrobson.png"
                    alt=""
                  />
                  <a className="username mg-l-15px-r-10px">amberson</a>
                  <p className="tag mg-r-10px">you</p>
                  <p className="period">1 month ago</p>
                </div>
                <div>
                  <button className="btn btn-delete">
                    <img src="./images/icon-delete.svg" /> Delete
                  </button>
                  <button className="btn btn-edit">
                    <img src="./images/icon-edit.svg" /> Edit
                  </button>
                </div>
              </div>
              <p className="comment hidden">
                lorem ipsum dolor sit amet consectetur adipisicing elit sed do
                eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut
                enim ad minim veniam quis nostrud exercitation ullamco laboris
                nisi ut aliquip ex ea commodo consequat.
              </p>
              <textarea
                name="text"
                placeholder="Add a comment..."
                className=""
                cols="30"
                rows="10"
              ></textarea>
            </div>
          </div>
        );
      }

      class App extends React.Component {
        constructor(props) {
          super(props);
          this.commentHandler = this.commentHandler.bind(this);
          this.state = {
            currentUser: false,
            comments: false,
          };
        }

        checkUser(username) {
          try {
            if (username == this.state.currentUser.username) {
              return true;
            }
          } catch (e) {
            return false;
          }
        }

        checkCommentDate(date) {
          const currentDate = new Date();
          const commentDate = new Date(date);
          const diffTime = Math.abs(currentDate - commentDate);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) - 1;
          if (diffDays === 0) {
            return "today";
          } else if (diffDays === 1) {
            return "yesterday";
          } else if (diffDays > 1 && diffDays < 7) {
            return diffDays + " days ago";
          } else if (diffDays >= 7 && diffDays < 30) {
            return Math.ceil(diffDays / 7) + " weeks ago";
          } else if (diffDays >= 30) {
            return Math.ceil(diffDays / 30) + " months ago";
          }
        }

        commentHandler(comment) {
          this.setState({
            comments: [
              ...this.state.comments,
              {
                id: this.state.comments.length + 1,
                score: 0,
                createdAt: this.checkCommentDate(new Date().toLocaleString()),
                content: comment,
                user: {
                  image: {
                    png: this.state.currentUser.image.png,
                    webp: this.state.currentUser.image.webp,
                  },
                  username: this.state.currentUser.username,
                },
                replies: [],
              },
            ],
          });
        }

        componentDidMount() {
          fetch(
            "https://raw.githubusercontent.com/AcmeGamers/Interactive-Comments-Section/master/data.json"
          )
            .then((response) => response.json())
            .then((data) => {
              this.setState({
                currentUser: data.currentUser,
                comments: data.comments,
              });
            });
        }

        render() {
          return (
            <div>
              <CardEditReply />
              {this.state.comments &&
                this.state.comments.map((record) => (
                  <Card
                    key={record.id}
                    score={record.score}
                    username={record.user.username}
                    createdAt={record.createdAt}
                    content={record.content}
                    image={record.user.image.png}
                    currentUser={this.state.currentUser}
                  >
                    {record.replies == []
                      ? ""
                      : record.replies.map((reply) => (
                          <CardReply
                            key={reply.id}
                            score={reply.score}
                            username={reply.user.username}
                            createdAt={reply.createdAt}
                            content={reply.content}
                            image={reply.user.image.png}
                            currentUser={this.state.currentUser}
                          />
                        ))}
                  </Card>
                ))}
              {this.state.comments && (
                <CommentCard
                  currentUser={this.state.currentUser}
                  comments={this.state.comments}
                  commentHandler={this.commentHandler}
                />
              )}
            </div>
          );
        }
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
